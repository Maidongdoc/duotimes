<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>倒计时</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #f2f0eb;
      --card: #ddcfbb;
      --chip: #c6b6aa;
      --text-main: #2f2f2f;
      --text-muted: #7a7a7a;
      --accent: #ffffff;
      --finished: #efe5d6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    .container { max-width: 420px; margin: 0 auto; padding: 16px 14px 40px; }
    h1 { font-size: 22px; margin: 8px 0 14px; font-weight: 600; }
    .presets { display: flex; gap: 6px; margin-bottom: 14px; }
    .chip { padding: 6px 10px; border-radius: 12px; background: var(--chip); font-size: 12px; border: none; cursor: pointer; }
    .timers { display: flex; flex-direction: column; gap: 12px; }
    .timer { background: var(--card); border-radius: 16px; padding: 12px; display: flex; gap: 12px; box-shadow: 0 4px 10px rgba(0,0,0,.05); }
    .timer.finished { background: var(--finished); }
    .timer-main { flex: 1; }
    .name { font-size: 14px; color: var(--text-muted); border: none; background: transparent; width: 100%; margin-bottom: 6px; }
    .time { font-size: 30px; font-weight: 600; font-variant-numeric: tabular-nums; }
    .done-label { font-size: 12px; color: var(--text-muted); display: none; }
    .actions { display: flex; gap: 10px; }
    .action-btn { width: 44px; height: 44px; border-radius: 14px; border: none; background: var(--accent); font-size: 18px; cursor: pointer; }
    #customModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); align-items:center; justify-content:center; }
    #customModal .panel { background:#fff; border-radius:16px; padding:16px; width:260px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>倒计时</h1>
    <div class="presets">
      <button class="chip" onclick="addTimerFromMinutes(5)">5 min</button>
      <button class="chip" onclick="addTimerFromMinutes(15)">15 min</button>
      <button class="chip" onclick="addTimerFromMinutes(20)">20 min</button>
      <button class="chip" onclick="addTimerFromMinutes(30)">30 min</button>
      <button class="chip" onclick="addCustom()">自定义</button>
    </div>
    <div class="timers" id="timers"></div>
  </div>

  <div id="customModal">
    <div class="panel">
      <div style="margin-bottom:8px">输入分钟数</div>
      <input id="customInput" type="number" min="1" />
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button onclick="hideCustomModal()">取消</button>
        <button onclick="confirmCustomModal()">确定</button>
      </div>
    </div>
  </div>

<script>
  const timersEl = document.getElementById('timers');
  const STORAGE_KEY = 'countdown_timers_v1';

  function formatTime(sec) {
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    return `${m}:${s}`;
  }

  function saveTimers() {
    const data = [];
    document.querySelectorAll('.timer').forEach(el => {
      data.push({
        name: el._name.value,
        remaining: el._remaining,
        running: el._running
      });
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadTimers() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      JSON.parse(raw).forEach(t => {
        createTimer(t.remaining, t.name, t.running);
      });
    } catch {}
  }

  function addTimerFromMinutes(min) { createTimer(min * 60); }
  function addCustom() { showCustomModal(); }

  function showCustomModal() {
    customModal.style.display = 'flex';
    customInput.value = '';
    customInput.focus();
  }
  function hideCustomModal() { customModal.style.display = 'none'; }
  function confirmCustomModal() {
    const min = parseInt(customInput.value, 10);
    hideCustomModal();
    if (min > 0) createTimer(min * 60);
  }

  function notifyFinish(timerName) {
    if (!('speechSynthesis' in window)) return;
    const text = `${timerName} 时间到`;
    let count = 0;
    function speakOnce() {
      if (count >= 3) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'zh-CN';
      utter.rate = 1;
      utter.pitch = 1;
      utter.volume = 1;
      utter.onend = () => {
        count++;
        setTimeout(speakOnce, 400);
      };
      window.speechSynthesis.speak(utter);
    }
    speakOnce();
  }

  function createTimer(initialSeconds, name = '任务名称', autoRun = false) {
    let remaining = initialSeconds;
    let endTime = null;
    let interval = null;

    const el = document.createElement('div');
    el.className = 'timer';

    el.innerHTML = `
      <div class="timer-main">
        <input class="name" />
        <div class="time"></div>
        <div class="done-label">完成 ✓</div>
      </div>
      <div class="actions">
        <button class="action-btn play">▶</button>
        <button class="action-btn reset">↺</button>
        <button class="action-btn delete">✕</button>
      </div>`;

    const nameEl = el.querySelector('.name');
    const timeEl = el.querySelector('.time');
    const doneLabel = el.querySelector('.done-label');
    const playBtn = el.querySelector('.play');

    nameEl.value = name;
    timeEl.textContent = formatTime(remaining);

    el._name = nameEl;
    el._remaining = remaining;
    el._running = false;

    function render() {
      timeEl.textContent = formatTime(remaining);
      el._remaining = remaining;
      saveTimers();
    }

    function stop() {
      if (interval) clearInterval(interval);
      interval = null;
      el._running = false;
      playBtn.textContent = '▶';
    }

    function tick() {
      const left = Math.ceil((endTime - Date.now()) / 1000);
      if (left <= 0) {
        remaining = 0;
        stop();
        el.classList.add('finished');
        doneLabel.style.display = 'block';
        notifyFinish(nameEl.value || '计时器');
        render();
        return;
      }
      remaining = left;
      render();
    }

    function start() {
      if (interval) return;
      endTime = Date.now() + remaining * 1000;
      el.classList.remove('finished');
      doneLabel.style.display = 'none';
      el._running = true;
      playBtn.textContent = '⏸';
      interval = setInterval(tick, 250);
    }

    playBtn.onclick = () => interval ? stop() : start();
    el.querySelector('.reset').onclick = () => { stop(); remaining = initialSeconds; render(); };
    el.querySelector('.delete').onclick = () => { stop(); el.remove(); saveTimers(); };

    timersEl.prepend(el);
    render();

    if (autoRun) start();
  }

  // 初始化
  loadTimers();
  if (!timersEl.children.length) addTimerFromMinutes(30);

  // 测试
  function runTests() {
    console.assert(formatTime(61) === '01:01');
    console.assert(formatTime(-1) === '00:00');
    console.log('tests passed');
  }
  if (location.hash === '#test') runTests();
</script>
</body>
</html>
